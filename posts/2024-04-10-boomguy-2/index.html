<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://bin-cat.github.io/deep-thought.css" rel="stylesheet" />
  
  <link href="https://bin-cat.github.io/custom.css" rel="stylesheet" />


  <title>
    
Логово Бинария Котеевича | BoomGuy. Часть 2. Как страдали разработчики или хитрость из 1987

  </title>

  
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;bin-cat.github.io">Логово Бинария Котеевича</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bin-cat.github.io&#x2F;">
            Главная
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;bin-cat.github.io&#x2F;posts">
            Посты
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            BoomGuy. Часть 2. Как страдали разработчики или хитрость из 1987
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>BinaryCat published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2024-04-10">April 10, 2024</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>3 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>544 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
              
<p>
  Tags:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://bin-cat.github.io/tags/boomguy/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>BoomGuy</span>
    </span>
  </a>
  
</p>

              
            </div>
          </div>
          <div class="content mt-2">
            <p>Железо в NES было слабенькое, поэтому разработчикам часто приходилось придумывать, как бы поэффективнее организовать свой код. И вот во внутренностях Bomberman я нактнулся на интересное, как мне показалось, место.</p>
<span id="continue-reading"></span>
<p>Начнем с того, что проц в NES был по вычислительным способностям на уровне первоклассника. Это сейчас у нас железо умеет практически мгновенно выполнять все арифмитические действия над огромными числами, а тогда 6502 был не в состоянии даже перемножить или поделить 2 числа. Почти не мог, потому что он умел сдвигать биты, что по сути является умножением/делением на степени двойки.</p>
<p>Так вот, как нам узнать может ли Бомбер пройти в соседнюю клетку, если у нас уровень хранится в виде длинной колбасы байт, его позиция хранится как X и Y координаты, а процессор умеет только складывать да вычитать, и то может это делать с числами от 0 до 255?</p>
<p>Уровень устроен просто: это всегда прямоугольник 32x13 блоков, из них первая и последняя строка, а также первый и 2 последних столбца состоят из непробиваемых блоков, при этом последний столбец всегда остается за кадром. Такой размер выбран неспроста и если не вдаваться в технические подробности, то это просто количество тайлов 16x16 пикселей (при этом из-за высоты интерфейса нижняя строка влезает только наполовину), которые можно уместить в памяти NES без необходимости дорисовывания на лету.</p>
<p>Так как же нам получить нужный адрес для соседнего блока? Простая математика в виде <code>Y * 32 + X</code> (±1 в нужной координате в зависимости от направления движения) отпадает, мы ведь не можем умножать. Тогда заменим умножением сложением и используем <code>32 + ... + 32 + X</code>, где 32 повторим Y раз. Идея хорошая, но непредсказуемая, чем ниже спускается Бомбер, тем дольше нам нужно это все считать, а ведь по уровню еще шарится толпа врагов и каждому нужно знать может ли он идти дальше. Так что такой вариант тоже отпадает.</p>
<p>Сидели грустные разработчики Hudson Soft, и думали "Складывать долго, таблицу умножения не завезли. Постойте-ка... Таблицу!". За достоверность описываемых событий, конечно, не ручаюсь.</p>
<p>Вышли из сложившегося положения они следующим образом: в коде есть 2 таблицы, одна содержит шестнадцатеричные значения <code>$00 $20 $40 $60 $80 $A0 $C0 $E0 $00 $20 $40 $60 $80</code>, другая <code>$02 $02 $02 $02 $02 $02 $02 $02 $03 $03 $03 $03 $03</code>. Это ни что иное, как составные части адреса, где начинается строка уровня в памяти. Верхний левый угол находится по адресу <code>$0200</code> и так далее до <code>$039F</code>. Поэтому мы можем взять Y±1 координату Бомбера, получить по ней из этих таблиц значения, соответствующие началу строки уровня в памяти, прибавить к ним X±1 координату и мы на месте. В результате вместо долгих расчетов нам нужны только 2 чтения из памяти и одно сложение для любого места в пределах уровня. Быстро, удобно, красиво, а всего лишь пришлось пожертвовать 26 байтами в роме.</p>
<hr />
<p><strong>UPD 2024-04-11</strong></p>
<div class="has-text-centered">
	<img src="https:&#x2F;&#x2F;u.cubeupload.com&#x2F;BinaryCat&#x2F;bombermanstageaddr.png" alt="Пример" />
</div>
<p>Например так: Бомбер стоит по координатам <code>(5, 4)</code> и нам нужно узнать может ли он пройти вправо. Берем его Y координату (4), ищем в таблицах соответствующие значения, это <code>$80</code> и <code>$02</code>. Следовательно, интересующая нас строка начинается по адресу <code>$0280</code>. Прибавляем к координате X единицу и получаем 6. Прибавляем получившееся значение к нашему адресу и получаем адрес <code>$0286</code>. Смотрим, что у нас в этом месте бетонный блок и говорим "Неа, Бомбер туда пройти не может, пусть стоит и перебирает ногами на месте".</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;bin-cat.github.io&#x2F;posts&#x2F;2024-04-03-boomguy-1&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              BoomGuy. Часть 1. Вводная
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;bin-cat.github.io&#x2F;posts&#x2F;2024-08-28-chaser&#x2F;">
              Chaser (2003)<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  
  
  <script src="https://bin-cat.github.io/elasticlunr.min.js"></script>
  <script src="https://bin-cat.github.io/search_index.ru.js"></script><script src="https://bin-cat.github.io/js/site.js"></script>

  





  
  
</body>

</html>
